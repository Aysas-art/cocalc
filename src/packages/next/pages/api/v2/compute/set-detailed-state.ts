/*
Set the state of a component.   This is mainly used from the backend to convey information to user
about what is going on in a compute server.

Example use, where 'sk-eTUKbl2lkP9TgvFJ00001n' is a project api key.

curl -sk -u sk-eTUKbl2lkP9TgvFJ00001n: -d '{"id":"13","name":"foo","value":"bar389"}' -H 'Content-Type: application/json' https://cocalc.com/api/v2/compute/set-detailed-state
*/

import getProjectOrAccountId from "lib/account/get-account";
import setDetailedState from "@cocalc/server/compute/set-detailed-state";
import getParams from "lib/api/get-params";
import isCollaborator from "@cocalc/server/projects/is-collaborator";

export default async function handle(req, res) {
  try {
    res.json(await get(req));
  } catch (err) {
    res.json({ error: `${err.message}` });
    return;
  }
}

async function get(req) {
  // This is a bit complicated because it can be used by a project api key,
  // in which case project_id must not be passed in, or it can be auth'd
  // by a normal api key or account, in which case project_id must be passed in.
  const project_or_account_id = await getProjectOrAccountId(req);
  if (!project_or_account_id) {
    throw Error("invalid auth");
  }
  const {
    id,
    name,
    state,
    extra,
    timeout,
    progress,
    project_id: project_id0,
  } = getParams(req);

  let project_id;
  if (!project_id0) {
    project_id = project_or_account_id;
  } else {
    if (
      !(await isCollaborator({
        account_id: project_or_account_id,
        project_id: project_id0,
      }))
    ) {
      throw Error("must be a collaborator on project with compute server");
    }
    project_id = project_id0;
  }

  await setDetailedState({
    project_id,
    id,
    name,
    state,
    extra,
    timeout,
    progress,
  });
  return { status: "ok" };
}
