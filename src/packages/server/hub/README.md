This is code that was in the hub but belongs in server. It's
mostly legacy, and is not written in the style of the rest of the server code.
